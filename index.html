<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Ø³Ø­Ø¨ Ø´ÙÙ„ÙŠ</title>  

  <!-- Ø£Ø³Ø·Ø± Ù…Ø¶Ø§ÙØ© Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#020617">
  <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø¶Ø§ÙØ© -->

  <style>  
  :root {  
    --primary: #4f46e5;  
    --bg: #0f172a;  
    --text: #f9fafb;  
    --success: #34ff7f;  
    --warning: #ffb36b;  
  }  
  
  body {  
    margin: 0;  
    background: radial-gradient(circle at top, #1d4ed8 0, #020617 55%, #000);  
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",  
                "Roboto", "Helvetica Neue", Arial, sans-serif;  
    color: var(--text);  
  }  
  
  .app {  
    min-height: 100vh;  
    display: flex;  
    justify-content: center;  
    align-items: center;  
    padding: 20px;  
  }  
  
  .card {  
    width: 100%;  
    max-width: 550px;  
    background: #0b1e3b;  
    border-radius: 22px;  
    border: 1px solid #345;  
    box-shadow: 0 15px 35px #0008;  
    overflow: hidden;  
  }  
  
  .card-header {  
    padding: 15px 18px;  
    background: #133b63bb;  
    display: flex;  
    gap: 10px;  
    align-items: center;  
  }  
  
  .logo-circle {  
    width: 60px;  
    height: 60px;  
    border-radius: 50%;  
    background-image: url('https://i.postimg.cc/3JcgH4nG/20250531-135725-FF5FD6EA-7CFD-497A-8DAC-AB0A6C0BE816.png');  
    background-size: cover;  
    background-position: center;  
    border: none;  
    background-color: transparent;   
    flex-shrink: 0;
  }  
  
  .card-header h1 {  
    margin: 0;  
    font-size: 20px;  
    font-weight: 600;  
  }  

  .lang-toggle {
    margin-right: auto;
    display: flex;
    gap: 6px;
    align-items: center;
    font-size: 12px;
  }

  .lang-btn {
    background: #0a1024;
    border: 1px solid #334;
    border-radius: 999px;
    padding: 4px 10px;
    color: #f9fafb;
    cursor: pointer;
    opacity: 0.7;
    font-family: inherit;
  }

  .lang-btn.active {
    background: #f9fafb;
    color: #0a1024;
    opacity: 1;
  }
  
  .card-body {  
    padding: 18px 20px 20px;  
  }  

  /* Ø£Ø®ÙÙŠÙ†Ø§ Ø§Ù„Ù„ÙŠØ¨Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØªÙƒØ±Ø± Ø§Ù„Ø¬Ù…Ù„Ø© */
  #names-label {
    display: none;
  }

  .participants-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 14px;
  }

  .participants-left span {
    margin-left: 4px;
  }

  .edit-count-input {
    width: 80px;
    padding: 6px 8px;
    font-size: 13px;
    background: #0a1024;
    border-radius: 8px;
    border: 1px solid #334;
    color: white;
    direction: ltr;
    text-align: left;
    box-sizing: border-box;
  }

  .edit-toggle-btn {
    background: transparent;
    color: #ffb36b;
    border: 1px solid #ffb36b;
    padding: 6px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
    flex-shrink: 0;
  }
  
  textarea, input {  
    width: 100%;  
    background: #0a1024;  
    border-radius: 12px;  
    border: 1px solid #334;  
    color: white;  
    padding: 12px;  
    margin-bottom: 12px;  
    font-size: 15px;  
    font-family: inherit;  
    box-sizing: border-box;
    direction: rtl;
    text-align: right;
  }  
  
  textarea {  
    height: 220px;  
    overflow-y: scroll;  
    line-height: 1.2;  
    resize: none;  /* Ù„Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ù‚Ø·Ø©/Ø§Ù„Ù…Ù‚Ø¨Ø¶ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
  }  
  
  .btn {  
    padding: 14px 20px;  
    border-radius: 40px;  
    border: none;  
    cursor: pointer;  
    font-size: 16px;  
    transition: 0.25s;  
  }  
  
  .primary {  
    background: linear-gradient(135deg, #4b6fff, #5a8bff);  
    color: white;  
    width: 48%;  
  }  
  
  .ghost {  
    background: #122b47;  
    color: #fff;  
    width: 48%;  
  }  
  
  .tiny {  
    background: transparent;  
    color: #ffb36b;  
    border: 1px solid #ffb36b;  
    width: 120px;  
    flex-shrink: 0;  
  }  

  .tiny.secondary {
    margin-top: 8px;
  }
  
  .actions {  
    display: flex;  
    justify-content: space-between;  
    margin-top: 15px;  
  }  
  
  #result-wrapper {  
    background: #061830;  
    border: 1px solid #133a66;  
    padding: 15px;  
    border-radius: 16px;  
    margin-top: 15px;  
  }  
  
  #result {  
    margin-top: 10px;  
    font-size: 20px;  
    color: var(--success);  
    font-weight: 600;  
    min-height: 55px;   
    display: flex;  
    flex-direction: column;  
    align-items: flex-start;  
  }  
  
  #result-text {  
      font-size: 20px;  
      color: inherit;  
      font-weight: 600;  
      min-height: 32px;  
  }  
  
  .card-footer {  
    padding: 10px;  
    color: transparent;  
  }  
  </style>  
</head>  
  
<body>  

<div class="app">  
  <div class="card">  
  
    <div class="card-header">  
      <div class="logo-circle"></div>  
      <h1 id="header-title">Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø´ÙÙ„ÙŠ ğŸ‰</h1>  
      <div class="lang-toggle">
        <button type="button" class="lang-btn active" data-lang="ar">Ø¹Ø±Ø¨ÙŠ</button>
        <button type="button" class="lang-btn" data-lang="en">English</button>
      </div>
    </div>  
  
    <div class="card-body">  

      <!-- Ø§Ù„Ù„ÙŠØ¨Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø®ÙÙŠ -->
      <label id="names-label">ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:</label>  

      <!-- Ø³Ø·Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ + Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­ÙØ¸ -->
      <div class="participants-row">
        <div class="participants-left">
          <span id="participants-count-label">Ø¹Ø¯Ø¯ Ø£Ø³Ù…Ø§Ø¡</span>
          <span id="participants-count-value">0</span>
          <span id="participants-count-after">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:</span>
          <input id="participants-count-input" class="edit-count-input" type="number" min="0" style="display:none;">
        </div>
        <button type="button" class="edit-toggle-btn" id="editToggleBtn" onclick="toggleEditMode()">ØªØ¹Ø¯ÙŠÙ„</button>
      </div>

      <!-- Ø§Ù„Ù…Ø±Ø¨Ø¹: Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ -->
      <textarea id="names"></textarea>  
  
      <div id="winnerRow" style="display:flex; gap:10px; align-items:flex-start; margin-top:10px;">  
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">  
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 1">  
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 2">  
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 3">  
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 4">  
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 5">  
        </div>  
        <div style="display:flex; flex-direction:column; gap:8px;">
          <button class="btn tiny" id="hideNamesBtn" onclick="hideNames()">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
          <button class="btn tiny secondary" id="autoModeBtn" onclick="enableAutoMode()">Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
        </div>
      </div>  
  
      <div class="actions">  
        <button class="btn primary" id="startDrawBtn" onclick="startDraw()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨</button>  
        <button class="btn ghost" id="resetBtn" onclick="resetWinners()">Ø¨Ø­Ø«</button>  
      </div>  
  
      <div id="result-wrapper">  
        <div id="result-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</div>  
        <div id="result">  
            <span id="result-text">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.</span>  
        </div>  
      </div>  
  
    </div>  
  
    <div class="card-footer"></div>  
  
  </div>  
</div>  

<script>  
// Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª
const translations = {
  ar: {
    pageTitle: "Ø³Ø­Ø¨ Ø´ÙÙ„ÙŠ",
    headerTitle: "Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø´ÙÙ„ÙŠ ğŸ‰",
    namesLabelBase: "ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:",
    hideNamesBtn: "Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡",
    autoModeBtn: "Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    startDrawBtn: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨",
    resetBtn: "Ø¨Ø­Ø«",
    resultLabel: "Ø§Ù„Ù†ØªÙŠØ¬Ø©:",
    defaultResult: "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.",
    warnNoWinnerNames: "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡",
    warnNoParticipants: "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨",
    warnNoSavedWinners: "âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    doneAllWinners: "âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†.",
    doneAllWinnersAuto: "âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.",
    searchWillStart: "Ø³ÙˆÙ ÙŠØ¨Ø¯Ø§ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙØ§Ø¦Ø²",
    autoModeActivated: "Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.",
    drawingInProgress: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...",
    winnerPlaceholderPrefix: "Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² ",
    participantsCountLabel: "Ø¹Ø¯Ø¯ Ø£Ø³Ù…Ø§Ø¡",
    participantsCountAfter: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:",
    editButton: "ØªØ¹Ø¯ÙŠÙ„",
    saveButton: "Ø­ÙØ¸"
  },
  en: {
    pageTitle: "Shfli Draw",
    headerTitle: "Prize from Shfli App ğŸ‰",
    namesLabelBase: "All participants:",
    hideNamesBtn: "Hide winners",
    autoModeBtn: "Auto pick",
    startDrawBtn: "Start draw",
    resetBtn: "Reset",
    resultLabel: "Result:",
    defaultResult: "Draw has not started yet.",
    warnNoWinnerNames: "âš ï¸ Please type at least one winner name before hiding the fields",
    warnNoParticipants: "âš ï¸ Please enter the participants' names in the box above before drawing",
    warnNoSavedWinners: "âš ï¸ Type the winners' names then click Hide winners or use auto pick",
    doneAllWinners: "âœ… All configured winners have been drawn.",
    doneAllWinnersAuto: "âœ… All winners have been randomly selected from the participants list.",
    searchWillStart: "Search for the winner will start",
    autoModeActivated: "Winners will be randomly selected from the participants list.",
    drawingInProgress: "Drawing...",
    winnerPlaceholderPrefix: "Winner ",
    participantsCountLabel: "Number of names",
    participantsCountAfter: "participants:",
    editButton: "Edit",
    saveButton: "Save"
  }
};

let currentLang = 'ar';
let generatedNames = [];  
let savedWinners = [];  
let drawIndex = 0;     

let drawMode = 'manual'; // 'manual' Ø£Ùˆ 'auto'
let autoWinners = [];
const AUTO_WINNERS_COUNT = 5;

// Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­ÙØ¸
let isEditMode = false;

// ========= Ø£ØµÙˆØ§Øª Ø§Ù„Ù†Ø·Ù‚ (ØªØ­Ø¶ÙŠØ± ØµÙˆØª Ø´Ø§Ø¨) =========
let allVoices = [];
let maleArabicVoice = null;
let maleEnglishVoice = null;

function loadVoices() {
  allVoices = window.speechSynthesis.getVoices() || [];
  if (!allVoices.length) return;

  const maleNamePattern = /male|man|boy|ahmed|ahmad|hamad|hammad|hazem|fadi|hassan|hassan|mohammad|mohamed|omar|khaled|saud|salim|majed|abdullah|yousef|yusuf|ali|faisal/i;

  const arVoices = allVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ar'));
  const enVoices = allVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));

  maleArabicVoice = arVoices.find(v => maleNamePattern.test(v.name)) || arVoices[0] || null;
  maleEnglishVoice = enVoices.find(v => maleNamePattern.test(v.name)) || enVoices[0] || null;
}

window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();
// =========================================

function setLanguage(lang) {
  currentLang = lang;
  applyLanguage();
}

function applyLanguage() {
  const t = translations[currentLang];

  document.title = t.pageTitle;
  document.documentElement.lang = currentLang === 'ar' ? 'ar' : 'en';

  const headerTitle = document.getElementById('header-title');
  if (headerTitle) headerTitle.textContent = t.headerTitle;

  const hideBtn = document.getElementById('hideNamesBtn');
  if (hideBtn) hideBtn.textContent = t.hideNamesBtn;

  const autoBtn = document.getElementById('autoModeBtn');
  if (autoBtn) autoBtn.textContent = t.autoModeBtn;

  const startBtn = document.getElementById('startDrawBtn');
  if (startBtn) startBtn.textContent = t.startDrawBtn;

  const resetBtn = document.getElementById('resetBtn');
  if (resetBtn) resetBtn.textContent = t.resetBtn;

  const resultLabel = document.getElementById('result-label');
  if (resultLabel) resultLabel.textContent = t.resultLabel;

  const resultText = document.getElementById('result-text');
  if (resultText) {
    if (resultText.textContent.includes("Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.") ||
        resultText.textContent.includes("Draw has not started yet.")) {
      resultText.textContent = t.defaultResult;
    }
  }

  const winnerInputs = document.querySelectorAll('.winner-input');
  winnerInputs.forEach((inp, idx) => {
    if (currentLang === 'ar') {
      inp.placeholder = `${t.winnerPlaceholderPrefix}${idx + 1}`;
    } else {
      inp.placeholder = `${t.winnerPlaceholderPrefix}${idx + 1} name`;
    }
  });

  const countLabel = document.getElementById("participants-count-label");
  if (countLabel) countLabel.textContent = t.participantsCountLabel;

  const countAfter = document.getElementById("participants-count-after");
  if (countAfter) countAfter.textContent = t.participantsCountAfter;

  const editToggleBtn = document.getElementById("editToggleBtn");
  if (editToggleBtn) {
    editToggleBtn.textContent = isEditMode ? t.saveButton : t.editButton;
  }
}

function loadNamesFromTextarea() {  
  const textarea = document.getElementById("names");  
  if (!textarea) return;  

  generatedNames = textarea.value
    .split(/\r?\n/)
    .map(n => n.trim())
    .filter(n => n !== "");

  const countInput = document.getElementById("participants-count-input");
  const countValueSpan = document.getElementById("participants-count-value");
  if (countInput && isEditMode) {
    if (!countInput.value && generatedNames.length > 0) {
      countInput.value = generatedNames.length;
      if (countValueSpan && countValueSpan.textContent === "0") {
        countValueSpan.textContent = generatedNames.length;
      }
    }
  }
}  

function showRandomNamesBlock() {  
  const textarea = document.getElementById("names");  
  if (!textarea) return;  
  textarea.value = generatedNames.join("\n");  
}  

function hideNames() {  
  const inputs = document.querySelectorAll(".winner-input");  
  const temp = [];  
  const resultDiv = document.getElementById("result");  
    
  resultDiv.innerHTML = '<span id="result-text"></span>';  
  const resultText = document.getElementById('result-text');  
  
  inputs.forEach(inp => {  
    const v = inp.value.trim();  
    if (v) temp.push(v);  
    inp.value = "";  
  });  
  
  if (temp.length === 0) {  
    resultText.textContent = translations[currentLang].warnNoWinnerNames;  
    resultText.style.color = "var(--warning)";  
    return;  
  }  

  loadNamesFromTextarea();
  if (generatedNames.length === 0) {
    resultText.textContent = translations[currentLang].warnNoParticipants;
    resultText.style.color = "var(--warning)";
    return;
  }
  
  drawMode = 'manual';
  savedWinners = temp;  
  autoWinners = [];
  drawIndex = 0;  
  document.getElementById("winnerRow").style.display = "none";  
  resultText.textContent = translations[currentLang].searchWillStart;  
  resultText.style.color = "#eee";  
}  

function enableAutoMode() {
  const resultDiv = document.getElementById("result");  
  resultDiv.innerHTML = '<span id="result-text"></span>';  
  const resultText = document.getElementById('result-text');

  loadNamesFromTextarea();
  if (generatedNames.length === 0) {
    resultText.textContent = translations[currentLang].warnNoParticipants;
    resultText.style.color = "var(--warning)";
    return;
  }

  drawMode = 'auto';
  savedWinners = [];
  autoWinners = [];
  drawIndex = 0;

  document.getElementById("winnerRow").style.display = "none";
  resultText.textContent = translations[currentLang].autoModeActivated;
  resultText.style.color = "#eee";
}
  
function resetWinners() {  
  savedWinners = [];  
  autoWinners = [];
  drawMode = 'manual';
  drawIndex = 0;  
  document.getElementById("winnerRow").style.display = "flex";  
    
  const resultDiv = document.getElementById("result");  
  resultDiv.innerHTML = `<span id="result-text">${translations[currentLang].defaultResult}</span>`;  
  
  const inputs = document.querySelectorAll(".winner-input");  
  inputs.forEach(inp => inp.value = "");  
    
  loadNamesFromTextarea();  
}  

function getWinnerAnnouncement(num, name) {
  if (currentLang === 'ar') {
    return `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø±Ù‚Ù… ${num}: ${name} ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ!`;
  } else {
    return `ğŸ† Winner #${num}: ${name} ğŸ‰ Congratulations!`;
  }
}

function getSpeakCongrats(name) {
  if (currentLang === 'ar') {
    return `Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø² ${name}`;
  } else {
    return `Congratulations to the winner ${name}`;
  }
}
  
function speak(text) {  
  const msg = new SpeechSynthesisUtterance(text);  
  msg.lang = currentLang === 'ar' ? "ar-SA" : "en-US";  

  if (!allVoices || !allVoices.length) {
    loadVoices();
  }

  let chosenVoice = null;
  if (currentLang === 'ar') {
    chosenVoice = maleArabicVoice || maleEnglishVoice || (allVoices[0] || null);
  } else {
    chosenVoice = maleEnglishVoice || maleArabicVoice || (allVoices[0] || null);
  }

  if (chosenVoice) {
    msg.voice = chosenVoice;
  }

  msg.rate = 1;  
  speechSynthesis.cancel();  
  speechSynthesis.speak(msg);  
}  
  
function startDraw() {  
  const startDrawBtn = document.getElementById("startDrawBtn");  
  const resetBtn = document.getElementById("resetBtn");  
  const resultDiv = document.getElementById("result");  
  let resultText = document.getElementById("result-text");  
  
  if (!resultText) {  
      resultDiv.innerHTML = '<span id="result-text"></span>';  
      resultText = document.getElementById("result-text");  
  }  

  loadNamesFromTextarea();
  if (generatedNames.length === 0) {
    resultText.textContent = translations[currentLang].warnNoParticipants;
    resultText.style.color = "var(--warning)";
    return;
  }

  if (drawMode === 'manual' && savedWinners.length === 0) {  
    resultText.textContent = translations[currentLang].warnNoSavedWinners;  
    resultText.style.color = "var(--warning)";  
    return;  
  }  

  if (drawMode === 'manual' && drawIndex >= savedWinners.length) {  
    resultText.textContent = translations[currentLang].doneAllWinners;  
    resultText.style.color = "var(--success)";  
    return;  
  }

  if (drawMode === 'auto' && autoWinners.length >= AUTO_WINNERS_COUNT) {
    resultText.textContent = translations[currentLang].doneAllWinnersAuto;  
    resultText.style.color = "var(--success)";  
    return;
  }
  
  startDrawBtn.disabled = true;  
  resetBtn.disabled = true;  
  
  const intervalTime = 40;       
  const totalDuration = 10000;   
  const startTime = Date.now();  
  
  let lastNamesUpdate = 0;  
  const namesUpdateInterval = 300;   
  
  resultText.textContent = translations[currentLang].drawingInProgress;  
  resultText.style.color = "#eee";  
  
  const currentDrawNumber = (drawMode === 'manual')
    ? (drawIndex + 1)
    : (autoWinners.length + 1);
  
  const interval = setInterval(() => {  
    const now = Date.now();  
    const elapsed = now - startTime;  

    if (generatedNames.length > 0) {
      const randomName = generatedNames[Math.floor(Math.random() * generatedNames.length)];  
      resultText.textContent = randomName;  
    }
  
    if (now - lastNamesUpdate >= namesUpdateInterval && generatedNames.length > 0) {  
      const textarea = document.getElementById("names");  
      const linesPerView = 40;   
      const out = [];  
  
      for (let i = 0; i < linesPerView; i++) {  
        const name = generatedNames[Math.floor(Math.random() * generatedNames.length)];  
        out.push(name);  
      }  
      textarea.value = out.join("\n");  
      lastNamesUpdate = now;  
    }  
  
    if (elapsed >= totalDuration) {  
      clearInterval(interval);  

      let winnerName;
      if (drawMode === 'manual') {
        winnerName = savedWinners[drawIndex];
        drawIndex++;
      } else {
        const available = generatedNames.filter(n => !autoWinners.includes(n));
        if (available.length === 0) {
          winnerName = null;
        } else {
          winnerName = available[Math.floor(Math.random() * available.length)];
          autoWinners.push(winnerName);
        }
      }

      if (winnerName) {
        resultText.style.color = "var(--success)";  
        resultText.textContent = getWinnerAnnouncement(currentDrawNumber, winnerName);  
        speak(getSpeakCongrats(winnerName));  
      } else {
        resultText.style.color = "var(--warning)";
        resultText.textContent = translations[currentLang].warnNoParticipants;
      }

      startDrawBtn.disabled = false;  
      resetBtn.disabled = false;  
      showRandomNamesBlock();  
    }  
  }, intervalTime);  
}  

function toggleEditMode() {
  const namesTextarea = document.getElementById("names");
  const countInput = document.getElementById("participants-count-input");
  const countValue = document.getElementById("participants-count-value");
  const editToggleBtn = document.getElementById("editToggleBtn");

  if (!namesTextarea || !countInput || !countValue || !editToggleBtn) return;

  if (isEditMode) {
    namesTextarea.readOnly = true;
    isEditMode = false;

    let val = countInput.value.trim();
    if (val === "") val = "0";
    countValue.textContent = val;
    countInput.style.display = "none";
    countValue.style.display = "inline";

    editToggleBtn.textContent = translations[currentLang].editButton;
  } else {
    namesTextarea.readOnly = false;
    isEditMode = true;

    const currentText = countValue.textContent.replace(/[^\d]/g, "");
    countInput.value = currentText || "";
    countInput.style.display = "inline-block";
    countValue.style.display = "none";

    editToggleBtn.textContent = translations[currentLang].saveButton;
  }
}

function initApp() {
  const namesTextarea = document.getElementById("names");
  if (namesTextarea) {
    namesTextarea.readOnly = true;
  }

  const langButtons = document.querySelectorAll(".lang-btn");
  langButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const lang = btn.getAttribute("data-lang");
      langButtons.forEach(b => b.classList.toggle("active", b === btn));
      setLanguage(lang);
    });
  });

  loadNamesFromTextarea();
  setLanguage('ar');
}

document.addEventListener("DOMContentLoaded", function () {
  initApp();
});
</script>  

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('service-worker.js');
    });
  }
</script>
  
</body>  
</html>
