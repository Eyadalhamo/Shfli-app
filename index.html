<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³Ø­Ø¨ Ø´ÙÙ„ÙŠ</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#020617">

  <style>
  :root {
    --primary: #4f46e5;
    --bg: #0f172a;
    --text: #f9fafb;
    --success: #34ff7f;
    --warning: #ffb36b;
  }

  body {
    margin: 0;
    background: radial-gradient(circle at top, #1d4ed8 0, #020617 55%, #000);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                "Roboto", "Helvetica Neue", Arial, sans-serif;
    color: var(--text);
  }

  .app {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .card {
    width: 100%;
    max-width: 550px;
    background: #0b1e3b;
    border-radius: 22px;
    border: 1px solid #345;
    box-shadow: 0 15px 35px #0008;
    overflow: hidden;
  }

  .card-header {
    padding: 15px 18px;
    background: #133b63bb;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .logo-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-image: url('https://i.postimg.cc/3JcgH4nG/20250531-135725-FF5FD6EA-7CFD-497A-8DAC-AB0A6C0BE816.png');
    background-size: cover;
    background-position: center;
    border: none;
    background-color: transparent;
    flex-shrink: 0;
  }

  .card-header h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  .card-body {
    padding: 18px 20px 20px;
  }

  textarea, input {
    width: 100%;
    background: #0a1024;
    border-radius: 12px;
    border: 1px solid #334;
    color: white;
    padding: 12px;
    margin-bottom: 12px;
    font-size: 15px;
    font-family: inherit;
    box-sizing: border-box;
    direction: rtl;
    text-align: right;
  }

  textarea {
    height: 220px;
    overflow-y: scroll;
    line-height: 1.2;
    resize: none;
  }

  .btn {
    padding: 14px 20px;
    border-radius: 40px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    transition: 0.25s;
  }

  .primary {
    background: linear-gradient(135deg, #4b6fff, #5a8bff);
    color: white;
    width: 48%;
  }

  .ghost {
    background: #122b47;
    color: #fff;
    width: 48%;
  }

  .tiny {
    background: transparent;
    color: #ffb36b;
    border: 1px solid #ffb36b;
    width: 120px;
    flex-shrink: 0;
  }

  .tiny.secondary {
    margin-top: 8px;
  }

  .actions {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
  }

  #result-wrapper {
    background: #061830;
    border: 1px solid #133a66;
    padding: 15px;
    border-radius: 16px;
    margin-top: 15px;
  }

  #result {
    margin-top: 10px;
    font-size: 20px;
    color: var(--success);
    font-weight: 600;
    min-height: 55px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  #result-text {
    font-size: 20px;
    color: inherit;
    font-weight: 600;
  }

  .card-footer {
    padding: 10px;
    color: transparent;
  }

  /* ØµÙ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
  #names-label {
    display: none;
  }

  .participants-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 14px;
  }

  .participants-left span {
    margin-left: 4px;
  }

  .edit-count-input {
    width: 80px;
    padding: 6px 8px;
    font-size: 13px;
    background: #0a1024;
    border-radius: 8px;
    border: 1px solid #334;
    color: white;
    direction: ltr;
    text-align: left;
    box-sizing: border-box;
  }

  .edit-toggle-btn {
    background: transparent;
    color: #ffb36b;
    border: 1px solid #ffb36b;
    padding: 6px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
    flex-shrink: 0;
  }

  .participants-actions {
    display: flex;
    gap: 8px;
  }

  /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø­Ø¨ */
  .settings-wrapper {
    margin-right: auto;
    position: relative;
  }

  .settings-btn {
    background: transparent;
    border: 1px solid #ffb36b;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 16px;
    cursor: pointer;
    color: #ffb36b;
  }

  .settings-menu {
    position: absolute;
    top: 110%;
    left: 0;
    min-width: 200px;
    background: #020617;
    border-radius: 14px;
    border: 1px solid #334;
    padding: 8px;
    box-shadow: 0 12px 25px #000a;
    display: none;
    z-index: 20;
  }

  .settings-group-title {
    font-size: 12px;
    opacity: 0.7;
    margin: 4px 4px 2px;
  }

  .settings-menu button {
    width: 100%;
    margin: 3px 0;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid transparent;
    background: #0b1e3b;
    color: #f9fafb;
    font-size: 13px;
    cursor: pointer;
    text-align: center;
  }

  .settings-menu button:hover {
    background: #1d4ed8;
  }

  .settings-menu .lang-btn {
    background: #0a1024;
    border: 1px solid #334;
    opacity: 0.9;
  }

  .settings-menu .lang-btn.active {
    background: #f9fafb;
    color: #0a1024;
    border-color: #f9fafb;
    opacity: 1;
  }

  .settings-separator {
    height: 1px;
    background: #1e293b;
    margin: 6px 0;
  }

  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 40;
  }

  .confirm-dialog {
    background: #020617;
    border-radius: 18px;
    border: 1px solid #334;
    padding: 18px 20px;
    max-width: 320px;
    width: 90%;
    box-shadow: 0 18px 40px #000c;
    text-align: center;
  }

  .confirm-dialog p {
    margin: 0 0 14px;
    font-size: 15px;
    line-height: 1.6;
  }

  .confirm-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .confirm-actions .btn {
    width: 100%;
  }

  body.light-mode {
    background: radial-gradient(circle at top, #dbeafe 0, #e5e7eb 55%, #ffffff);
    color: #020617;
  }

  body.light-mode .card {
    background: #ffffff;
    border-color: #d1d5db;
    box-shadow: 0 10px 25px #0002;
  }

  body.light-mode .card-header {
    background: #e0ebff;
  }

  body.light-mode textarea,
  body.light-mode input {
    background: #f9fafb;
    border-color: #d1d5db;
    color: #020617;
  }

  body.light-mode .ghost {
    background: #e5e7eb;
    color: #111827;
  }

  body.light-mode .primary {
    background: linear-gradient(135deg, #2563eb, #3b82f6);
  }

  body.light-mode #result-wrapper {
    background: #f3f4ff;
    border-color: #c7d2fe;
  }

  body.light-mode .settings-menu {
    background: #ffffff;
    border-color: #cbd5f5;
  }

  body.light-mode .settings-menu button {
    background: #eef2ff;
    color: #111827;
  }

  body.light-mode .settings-menu button:hover {
    background: #dbeafe;
  }

  body.light-mode .confirm-dialog {
    background: #ffffff;
    border-color: #d1d5db;
    color: #111827;
  }

  </style>
</head>

<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø®ÙÙŠÙ‘Ø© Ù„Ø­Ø¯ Ù…Ø§ ÙŠÙ†ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯) -->
<div id="app-screen" class="app" style="display:none;">
  <div class="card">
    <div class="card-header">
      <div class="logo-circle"></div>
      <h1 id="header-title">Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø´ÙÙ„ÙŠ ğŸ‰</h1>

      <div class="settings-wrapper">
        <button type="button" class="settings-btn" data-menu="settings-menu-app">âš™ï¸</button>
        <div class="settings-menu" id="settings-menu-app">
          <div class="settings-group-title" id="settings-lang-title-app">Ø§Ù„Ù„ØºØ©</div>
          <button type="button" class="lang-btn active" data-lang="ar">Ø¹Ø±Ø¨ÙŠ</button>
          <button type="button" class="lang-btn" data-lang="en">English</button>

          <div class="settings-separator"></div>

          <button type="button" id="theme-toggle-btn">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</button>

          <div class="settings-separator"></div>

          <button type="button" class="settings-share settings-item-app">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        </div>
      </div>
    </div>

    <div class="card-body">
      <label id="names-label">ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:</label>

      <div class="participants-row">
        <div class="participants-left">
          <span id="participants-count-label">Ø¹Ø¯Ø¯ Ø£Ø³Ù…Ø§Ø¡</span>
          <span id="participants-count-value">0</span>
          <span id="participants-count-after">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:</span>
          <input id="participants-count-input" class="edit-count-input" type="number" min="0" style="display:none;">
        </div>
        <div class="participants-actions">
          <button type="button" class="edit-toggle-btn" id="editToggleBtn">ØªØ¹Ø¯ÙŠÙ„</button>
          <button type="button" class="edit-toggle-btn" id="clearNamesBtn" style="display:none;">Ù…Ø³Ø­</button>
        </div>
      </div>

      <textarea id="names"></textarea>

      <div id="winnerRow" style="display:flex; gap:10px; align-items:flex-start; margin-top:10px;">
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 1">
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 2">
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 3">
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 4">
          <input class="winner-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² 5">
        </div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <button class="btn tiny" id="hideNamesBtn" type="button">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
          <button class="btn tiny secondary" id="autoModeBtn" type="button">Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="startDrawBtn" type="button">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨</button>
        <button class="btn ghost" id="resetBtn" type="button">Ø¨Ø­Ø«</button>
      </div>

      <div id="result-wrapper">
        <div id="result-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</div>
        <div id="result">
          <span id="result-text">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.</span>
        </div>
      </div>
    </div>

    <div class="card-footer"></div>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ 225522 -->
<div id="password-overlay" class="confirm-overlay">
  <div class="confirm-dialog">
    <p id="password-message">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù¦ Ø£Ø±Ù‚Ø§Ù…)</p>
    <input id="password-input" type="password" inputmode="numeric" maxlength="6"
           class="edit-count-input" style="width:100%;margin:10px 0;">
    <div class="confirm-actions">
      <button id="password-submit" class="btn primary">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>
</div>

<div id="confirm-overlay" class="confirm-overlay">
  <div class="confirm-dialog">
    <p id="confirm-message">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
    <div class="confirm-actions">
      <button id="confirm-yes" class="btn primary">Ù†Ø¹Ù…</button>
      <button id="confirm-no" class="btn ghost">Ù„Ø§</button>
    </div>
  </div>
</div>

<div id="welcome-overlay" class="confirm-overlay">
  <div class="confirm-dialog">
    <p>Ø£Ù‡Ù„Ø§Ù‹ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø³Ø­Ø¨ Ø´ÙÙ„ÙŠ ğŸ‘‹<br><br>
      Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ.<br>
      Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØªÙ†Ø­ÙØ¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠØªÙ… Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø¥ÙŠÙ…ÙŠÙ„.
    </p>
    <div class="confirm-actions">
      <button id="welcome-ok-btn" class="btn primary">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  import {
    getFirestore,
    doc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyD5Evcf4rCO-m3SmsNKZ3RGqeju0UCAmls",
    authDomain: "competitions-and-prizes.firebaseapp.com",
    projectId: "competitions-and-prizes",
    storageBucket: "competitions-and-prizes.firebasestorage.app",
    messagingSenderId: "15858009554",
    appId: "1:15858009554:web:50ea4181ec6e758f99f40b",
    measurementId: "G-VYHHVRP7T1"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const analytics = getAnalytics(firebaseApp);
  const db = getFirestore(firebaseApp);

  // ÙˆØ«ÙŠÙ‚Ø© Firestore Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ù…Ø´ØªØ±ÙƒØ© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)
  const NAMES_DOC_REF = doc(db, "drawConfig", "globalNamesV1");

  // ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const ACCESS_CODE = "225522";

  const translations = {
    ar: {
      pageTitle: "Ø³Ø­Ø¨ Ø´ÙÙ„ÙŠ",
      headerTitle: "Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘Ù…Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø´ÙÙ„ÙŠ ğŸ‰",

      namesLabelBase: "ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:",
      hideNamesBtn: "Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡",
      autoModeBtn: "Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      startDrawBtn: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨",
      resetBtn: "Ø¨Ø­Ø«",
      resultLabel: "Ø§Ù„Ù†ØªÙŠØ¬Ø©:",
      defaultResult: "Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.",
      warnNoWinnerNames: "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡",
      warnNoParticipants: "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø­Ø¨",
      warnNoSavedWinners: "âš ï¸ Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      doneAllWinners: "âœ… ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†.",
      doneAllWinnersAuto: "âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.",
      searchWillStart: "Ø³ÙˆÙ ÙŠØ¨Ø¯Ø§ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„ÙØ§Ø¦Ø²",
      autoModeActivated: "Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.",
      drawingInProgress: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...",
      winnerPlaceholderPrefix: "Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø² ",
      participantsCountLabel: "Ø¹Ø¯Ø¯ Ø£Ø³Ù…Ø§Ø¡",
      participantsCountAfter: "Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:",
      editButton: "ØªØ¹Ø¯ÙŠÙ„",
      saveButton: "Ø­ÙØ¸",
      settingsLangTitle: "Ø§Ù„Ù„ØºØ©",
      shareAppLabel: "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚",
      confirmYes: "Ù†Ø¹Ù…",
      confirmNo: "Ù„Ø§",
      passwordPrompt: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù¦ Ø£Ø±Ù‚Ø§Ù…)",
      passwordError: "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"
    },
    en: {
      pageTitle: "Shfli Draw",
      headerTitle: "Prize from Shfli App ğŸ‰",

      namesLabelBase: "All participants:",
      hideNamesBtn: "Hide winners",
      autoModeBtn: "Auto pick",
      startDrawBtn: "Start draw",
      resetBtn: "Reset",
      resultLabel: "Result:",
      defaultResult: "Draw has not started yet.",
      warnNoWinnerNames: "âš ï¸ Please type at least one winner name before hiding the fields",
      warnNoParticipants: "âš ï¸ Please enter the participants' names in the box above before drawing",
      warnNoSavedWinners: "âš ï¸ Type the winners' names then click Hide winners or use auto pick",
      doneAllWinners: "âœ… All configured winners have been drawn.",
      doneAllWinnersAuto: "âœ… All winners have been randomly selected from the participants list.",
      searchWillStart: "Search for the winner will start",
      autoModeActivated: "Winners will be randomly selected from the participants list.",
      drawingInProgress: "Drawing...",
      winnerPlaceholderPrefix: "Winner ",
      participantsCountLabel: "Number of names",
      participantsCountAfter: "participants:",
      editButton: "Edit",
      saveButton: "Save",
      settingsLangTitle: "Language",
      shareAppLabel: "Share app",
      confirmYes: "Yes",
      confirmNo: "No",
      passwordPrompt: "Please enter the 6-digit access code",
      passwordError: "Incorrect code, please try again"
    }
  };

  let currentLang = "ar";
  let generatedNames = [];
  let savedWinners = [];
  let drawIndex = 0;
  let drawMode = "manual";
  let autoWinners = [];
  const AUTO_WINNERS_COUNT = 5;
  let isEditMode = false;
  let savedNamesText = "";

  // Ù…ØªØºÙŠØ±Ø§Øª ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙØ§Ø¦Ø² Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
  let highlightIntervalId = null;
  let highlightedIndex = -1;

  let allVoices = [];
  let maleArabicVoice = null;
  let maleEnglishVoice = null;

  const STORAGE_KEYS = {
    NAMES: "shfli_saved_names"
  };

  const WELCOME_KEY = "shfli_welcome_shown";
  const THEME_KEY = "shfli_theme";

  function loadVoices() {
    allVoices = window.speechSynthesis.getVoices() || [];
    if (!allVoices.length) return;

    const maleNamePattern = /male|man|boy|ahmed|ahmad|hamad|hammad|hazem|fadi|hassan|mohammad|mohamed|omar|khaled|saud|salim|majed|abdullah|yousef|yusuf|ali|faisal/i;

    const arVoices = allVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ar'));
    const enVoices = allVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('en'));

    maleArabicVoice = arVoices.find(v => maleNamePattern.test(v.name)) || arVoices[0] || null;
    maleEnglishVoice = enVoices.find(v => maleNamePattern.test(v.name)) || enVoices[0] || null;
  }

  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  function setLanguage(lang) {
    currentLang = lang;
    applyLanguage();
    updateThemeButtonText();
  }

  function applyLanguage() {
    const t = translations[currentLang];

    document.title = t.pageTitle;

    const headerTitle = document.getElementById("header-title");
    if (headerTitle) headerTitle.textContent = t.headerTitle;

    const hideBtn = document.getElementById("hideNamesBtn");
    if (hideBtn) hideBtn.textContent = t.hideNamesBtn;

    const autoBtn = document.getElementById("autoModeBtn");
    if (autoBtn) autoBtn.textContent = t.autoModeBtn;

    const startBtn = document.getElementById("startDrawBtn");
    if (startBtn) startBtn.textContent = t.startDrawBtn;

    const resetBtn = document.getElementById("resetBtn");
    if (resetBtn) resetBtn.textContent = t.resetBtn;

    const resultLabel = document.getElementById("result-label");
    if (resultLabel) resultLabel.textContent = t.resultLabel;

    const resultText = document.getElementById("result-text");
    if (resultText) {
      if (resultText.textContent.includes("Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¹Ø¯.") ||
          resultText.textContent.includes("Draw has not started yet.")) {
        resultText.textContent = t.defaultResult;
      }
    }

    const winnerInputs = document.querySelectorAll(".winner-input");
    winnerInputs.forEach((inp, idx) => {
      if (currentLang === "ar") {
        inp.placeholder = `${t.winnerPlaceholderPrefix}${idx + 1}`;
      } else {
        inp.placeholder = `${t.winnerPlaceholderPrefix}${idx + 1} name`;
      }
    });

    const countLabel = document.getElementById("participants-count-label");
    if (countLabel) countLabel.textContent = t.participantsCountLabel;

    const countAfter = document.getElementById("participants-count-after");
    if (countAfter) countAfter.textContent = t.participantsCountAfter;

    const editToggleBtn = document.getElementById("editToggleBtn");
    if (editToggleBtn) {
      editToggleBtn.textContent = isEditMode ? t.saveButton : t.editButton;
    }

    const settingsLangTitles =
      document.querySelectorAll("#settings-lang-title-app");
    settingsLangTitles.forEach(el => el.textContent = t.settingsLangTitle);

    const shareBtns = document.querySelectorAll(".settings-share");
    shareBtns.forEach(btn => btn.textContent = t.shareAppLabel);

    const langButtons = document.querySelectorAll(".lang-btn");
    langButtons.forEach(btn => {
      const langAttr = btn.getAttribute("data-lang");
      btn.classList.toggle("active", langAttr === currentLang);
    });

    const confirmYes = document.getElementById("confirm-yes");
    const confirmNo = document.getElementById("confirm-no");
    if (confirmYes) confirmYes.textContent = t.confirmYes;
    if (confirmNo) confirmNo.textContent = t.confirmNo;

    const pwMsg = document.getElementById("password-message");
    if (pwMsg) pwMsg.textContent = t.passwordPrompt;
  }

  function updateThemeButtonText() {
    const btn = document.getElementById("theme-toggle-btn");
    if (!btn) return;
    const isLight = document.body.classList.contains("light-mode");
    if (currentLang === "ar") {
      btn.textContent = isLight ? "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†" : "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­";
    } else {
      btn.textContent = isLight ? "Dark mode" : "Light mode";
    }
  }

  function applyThemeFromStorage() {
    const saved = localStorage.getItem(THEME_KEY) || "dark";
    if (saved === "light") {
      document.body.classList.add("light-mode");
    } else {
      document.body.classList.remove("light-mode");
    }
    updateThemeButtonText();
  }

  function toggleTheme() {
    const isLight = document.body.classList.toggle("light-mode");
    localStorage.setItem(THEME_KEY, isLight ? "light" : "dark");
    updateThemeButtonText();
  }

  function loadNamesFromTextarea() {
    const textarea = document.getElementById("names");
    if (!textarea) return;

    savedNamesText = textarea.value;
    generatedNames = savedNamesText
      .split(/\r?\n/)
      .map(n => n.trim())
      .filter(n => n !== "");

    localStorage.setItem(STORAGE_KEYS.NAMES, savedNamesText);
  }

  // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù„Ù‰ Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© (ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø·)
  function onNamesInput() {
    if (!isEditMode) return;
    const namesTextarea = document.getElementById("names");
    if (!namesTextarea) return;

    savedNamesText = namesTextarea.value;
    generatedNames = savedNamesText
      .split(/\r?\n/)
      .map(n => n.trim())
      .filter(n => n !== "");

    localStorage.setItem(STORAGE_KEYS.NAMES, savedNamesText);

    const countValue = document.getElementById("participants-count-value");
    if (countValue) {
      countValue.textContent = String(generatedNames.length);
    }

    // Ø­ÙØ¸ ÙÙˆØ±ÙŠ Ø¹Ù„Ù‰ Firestore
    saveNamesToRemote();
  }

  // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¹ Firestore: Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø² ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹
  function subscribeToRemoteNames() {
    const namesTextarea = document.getElementById("names");
    const countValue = document.getElementById("participants-count-value");
    if (!namesTextarea) return;

    onSnapshot(NAMES_DOC_REF, (snapshot) => {
      if (!snapshot.exists()) return;
      const data = snapshot.data();
      const text = data.namesText || "";
      savedNamesText = text;

      // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù„Ø§ Ù†Ø²Ø¹Ø¬ ÙƒØªØ§Ø¨ØªÙ‡
      if (!isEditMode) {
        namesTextarea.value = text;
      }

      generatedNames = text
        .split(/\r?\n/)
        .map(n => n.trim())
        .filter(n => n !== "");

      if (countValue) countValue.textContent = String(generatedNames.length);
      localStorage.setItem(STORAGE_KEYS.NAMES, text);
    }, (err) => {
      console.error("Firestore listen error:", err);
    });
  }

  function loadSavedLocalData() {
    const namesTextarea = document.getElementById("names");
    if (!namesTextarea) return;

    const saved = localStorage.getItem(STORAGE_KEYS.NAMES);
    if (saved && saved.trim() !== "") {
      namesTextarea.value = saved;
      savedNamesText = saved;
      generatedNames = saved
        .split(/\r?\n/)
        .map(n => n.trim())
        .filter(n => n !== "");
      const countValue = document.getElementById("participants-count-value");
      if (countValue) {
        countValue.textContent = String(generatedNames.length);
      }
    }
  }

  function showRandomNamesBlock() {
    const textarea = document.getElementById("names");
    if (!textarea) return;
    textarea.value = savedNamesText;
  }

  // ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙØ§Ø¦Ø² Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: ğŸ”´ Ùˆ âšª ØªÙˆÙ…Ø¶ Ù‚Ø¯Ù‘Ø§Ù… Ø§Ù„Ø§Ø³Ù…
  function highlightWinnerInNames(name) {
    const textarea = document.getElementById("names");
    if (!textarea) return;

    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ØªÙ…ÙŠÙŠØ² Ù‚Ø¯ÙŠÙ…
    if (highlightIntervalId) {
      clearInterval(highlightIntervalId);
      highlightIntervalId = null;
      highlightedIndex = -1;
    }

    const lines = textarea.value.split(/\r?\n/);
    const target = name.trim();
    let idx = -1;

    for (let i = 0; i < lines.length; i++) {
      if (lines[i].trim() === target) {
        idx = i;
        break;
      }
    }

    if (idx === -1) {
      // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø­Ø±ÙØŒ Ù…Ø§ Ù†Ø¹Ù…Ù„ Ø´ÙŠØ¡
      return;
    }

    highlightedIndex = idx;
    let visible = true;

    highlightIntervalId = setInterval(() => {
      const ta = document.getElementById("names");
      if (!ta) {
        clearInterval(highlightIntervalId);
        highlightIntervalId = null;
        highlightedIndex = -1;
        return;
      }

      const currentLines = ta.value.split(/\r?\n/);
      if (highlightedIndex < 0 || highlightedIndex >= currentLines.length) {
        clearInterval(highlightIntervalId);
        highlightIntervalId = null;
        highlightedIndex = -1;
        return;
      }

      const rawLine = currentLines[highlightedIndex].replace(/^(?:ğŸ”´|âšª)\s*/, "");
      currentLines[highlightedIndex] =
        (visible ? "ğŸ”´ " : "âšª ") + rawLine;
      ta.value = currentLines.join("\n");
      visible = !visible;
    }, 500);
  }

  function getWinnerAnnouncement(num, name) {
    if (currentLang === "ar") {
      return `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ø±Ù‚Ù… ${num}: ${name} ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ!`;
    } else {
      return `ğŸ† Winner #${num}: ${name} ğŸ‰ Congratulations!`;
    }
  }

  function getSpeakCongrats(name) {
    if (currentLang === "ar") {
      return `Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø² ${name}`;
    } else {
      return `Congratulations to the winner ${name}`;
    }
  }

  function speak(text) {
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = currentLang === "ar" ? "ar-SA" : "en-US";

    if (!allVoices || !allVoices.length) {
      loadVoices();
    }

    let chosenVoice = null;
    if (currentLang === "ar") {
      chosenVoice = maleArabicVoice || maleEnglishVoice || (allVoices[0] || null);
    } else {
      chosenVoice = maleEnglishVoice || maleArabicVoice || (allVoices[0] || null);
    }

    if (chosenVoice) {
      msg.voice = chosenVoice;
    }

    msg.rate = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
  }

  function ensureNamesAvailable() {
    const resultDiv = document.getElementById("result");
    let resultText = document.getElementById("result-text");
    if (!resultText) {
      resultDiv.innerHTML = '<span id="result-text"></span>';
      resultText = document.getElementById("result-text");
    }

    loadNamesFromTextarea();

    if (generatedNames.length === 0) {
      resultText.textContent = translations[currentLang].warnNoParticipants;
      resultText.style.color = "var(--warning)";
      return false;
    }
    return true;
  }

  function hideNames() {
    if (!ensureNamesAvailable()) return;

    const inputs = document.querySelectorAll(".winner-input");
    const temp = [];
    const resultDiv = document.getElementById("result");

    resultDiv.innerHTML = '<span id="result-text"></span>';
    const resultText = document.getElementById("result-text");

    inputs.forEach(inp => {
      const v = inp.value.trim();
      if (v) temp.push(v);
      inp.value = "";
    });

    if (temp.length === 0) {
      resultText.textContent = translations[currentLang].warnNoWinnerNames;
      resultText.style.color = "var(--warning)";
      return;
    }

    drawMode = "manual";
    savedWinners = temp;
    autoWinners = [];
    drawIndex = 0;
    document.getElementById("winnerRow").style.display = "none";
    resultText.textContent = translations[currentLang].searchWillStart;
    resultText.style.color = "#eee";
  }

  function enableAutoMode() {
    if (!ensureNamesAvailable()) return;

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = '<span id="result-text"></span>';
    const resultText = document.getElementById("result-text");

    drawMode = "auto";
    savedWinners = [];
    autoWinners = [];
    drawIndex = 0;

    document.getElementById("winnerRow").style.display = "none";
    resultText.textContent = translations[currentLang].autoModeActivated;
    resultText.style.color = "#eee";
  }

  function resetWinners() {
    savedWinners = [];
    autoWinners = [];
    drawMode = "manual";
    drawIndex = 0;
    document.getElementById("winnerRow").style.display = "flex";

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `<span id="result-text">${translations[currentLang].defaultResult}</span>`;

    const inputs = document.querySelectorAll(".winner-input");
    inputs.forEach(inp => inp.value = "");

    const textarea = document.getElementById("names");
    if (textarea && savedNamesText) {
        textarea.value = savedNamesText;
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ÙˆÙ…ÙŠØ¶ Ù‚Ø¯ÙŠÙ…
    if (highlightIntervalId) {
      clearInterval(highlightIntervalId);
      highlightIntervalId = null;
      highlightedIndex = -1;
    }
  }

  function startDraw() {
    if (!ensureNamesAvailable()) return;

    // Ø¥Ù„ØºØ§Ø¡ ÙˆÙ…ÙŠØ¶ Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯
    if (highlightIntervalId) {
      clearInterval(highlightIntervalId);
      highlightIntervalId = null;
      highlightedIndex = -1;
    }

    const startDrawBtn = document.getElementById("startDrawBtn");
    const resetBtn = document.getElementById("resetBtn");
    const resultDiv = document.getElementById("result");
    let resultText = document.getElementById("result-text");

    if (!resultText) {
      resultDiv.innerHTML = '<span id="result-text"></span>';
      resultText = document.getElementById("result-text");
    }

    if (drawMode === "manual" && savedWinners.length === 0) {
      resultText.textContent = translations[currentLang].warnNoSavedWinners;
      resultText.style.color = "var(--warning)";
      return;
    }

    if (drawMode === "manual" && drawIndex >= savedWinners.length) {
      resultText.textContent = translations[currentLang].doneAllWinners;
      resultText.style.color = "var(--success)";
      return;
    }

    if (drawMode === "auto" && autoWinners.length >= AUTO_WINNERS_COUNT) {
      resultText.textContent = translations[currentLang].doneAllWinnersAuto;
      resultText.style.color = "var(--success)";
      return;
    }

    startDrawBtn.disabled = true;
    resetBtn.disabled = true;

    const intervalTime = 40;
    const totalDuration = 20000; // 20 Ø«Ø§Ù†ÙŠØ©

    const startTime = Date.now();

    let lastNamesUpdate = 0;
    const namesUpdateInterval = 300;

    resultText.textContent = translations[currentLang].drawingInProgress;
    resultText.style.color = "#eee";

    const currentDrawNumber =
      (drawMode === "manual") ? (drawIndex + 1) : (autoWinners.length + 1);

    const interval = setInterval(() => {
      const now = Date.now();
      const elapsed = now - startTime;

      if (generatedNames.length > 0) {
        const randomName =
          generatedNames[Math.floor(Math.random() * generatedNames.length)];
        resultText.textContent = randomName;
      }

      if (now - lastNamesUpdate >= namesUpdateInterval &&
          generatedNames.length > 0) {
        const textarea = document.getElementById("names");
        
        const scrollPos = textarea.scrollTop;
        
        const pool = [...generatedNames];
        for (let i = pool.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [pool[i], pool[j]] = [pool[j], pool[i]];
        }

        const out = pool.length > 10000 ? pool.slice(0, 10000) : pool; 
        
        textarea.value = out.join("\n");
        textarea.scrollTop = scrollPos;

        lastNamesUpdate = now;
      }

      if (elapsed >= totalDuration) {
        clearInterval(interval);

        let winnerName;
        if (drawMode === "manual") {
          winnerName = savedWinners[drawIndex];
          drawIndex++;
        } else {
          const available =
            generatedNames.filter(n => !autoWinners.includes(n));
          if (available.length === 0) {
            winnerName = null;
          } else {
            winnerName =
              available[Math.floor(Math.random() * available.length)];
            autoWinners.push(winnerName);
          }
        }

        if (winnerName) {
          resultText.style.color = "var(--success)";
          resultText.textContent =
            getWinnerAnnouncement(currentDrawNumber, winnerName);
          speak(getSpeakCongrats(winnerName));
        } else {
          resultText.style.color = "var(--warning)";
          resultText.textContent = translations[currentLang].warnNoParticipants;
        }

        startDrawBtn.disabled = false;
        resetBtn.disabled = false;

        // Ù†Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø«Ù… Ù†Ù…ÙŠÙ‘Ø² Ø§Ù„ÙØ§Ø¦Ø²
        showRandomNamesBlock();
        if (winnerName) {
          highlightWinnerInNames(winnerName);
        }
      }
    }, intervalTime);
  }

  async function saveNamesToRemote() {
    try {
      await setDoc(NAMES_DOC_REF, { namesText: savedNamesText }, { merge: true });
    } catch (err) {
      console.error("Failed to save names to Firestore:", err);
    }
  }

  function toggleEditMode() {
    const namesTextarea = document.getElementById("names");
    const countInput = document.getElementById("participants-count-input");
    const countValue = document.getElementById("participants-count-value");
    const editToggleBtn = document.getElementById("editToggleBtn");
    const clearBtn = document.getElementById("clearNamesBtn");

    if (!namesTextarea || !countInput || !countValue || !editToggleBtn) return;

    const t = translations[currentLang];

    if (isEditMode) {
      // Ø­ÙØ¸
      namesTextarea.readOnly = true;
      isEditMode = false;

      let val = countInput.value.trim();
      if (val === "") val = "0";
      countValue.textContent = val;
      countInput.style.display = "none";
      countValue.style.display = "inline";

      loadNamesFromTextarea();
      namesTextarea.value = savedNamesText;

      editToggleBtn.textContent = t.editButton;

      if (clearBtn) clearBtn.style.display = "none";

      // Ø­ÙØ¸ Ø¹Ù„Ù‰ Firestore Ù„ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ù„Ù†Ø§Ø³
      saveNamesToRemote();
    } else {
      // ØªØ¹Ø¯ÙŠÙ„
      namesTextarea.readOnly = false;
      isEditMode = true;

      const currentText = countValue.textContent.replace(/[^\d]/g, "");
      countInput.value = currentText || "";
      countInput.style.display = "inline-block";
      countValue.style.display = "none";

      editToggleBtn.textContent = t.saveButton;

      if (clearBtn) clearBtn.style.display = "inline-block";
    }
  }

  async function clearNames() {
    const namesTextarea = document.getElementById("names");
    const countInput = document.getElementById("participants-count-input");
    const countValue = document.getElementById("participants-count-value");

    if (namesTextarea) namesTextarea.value = "";
    if (countInput) countInput.value = "";
    if (countValue) countValue.textContent = "0";

    generatedNames = [];
    savedNamesText = "";
    savedWinners = [];
    autoWinners = [];
    drawIndex = 0;

    localStorage.removeItem(STORAGE_KEYS.NAMES);

    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ÙˆÙ…ÙŠØ¶ Ù‚Ø¯ÙŠÙ…
    if (highlightIntervalId) {
      clearInterval(highlightIntervalId);
      highlightIntervalId = null;
      highlightedIndex = -1;
    }

    // Ù…Ø³Ø­ Ù…Ù† Firestore Ø£ÙŠØ¶Ø§Ù‹
    try {
      await setDoc(NAMES_DOC_REF, { namesText: "" }, { merge: true });
    } catch (err) {
      console.error("Failed to clear names remotely:", err);
    }
  }

  function handleShareApp() {
    const t = translations[currentLang];
    const shareData = {
      title: t.pageTitle,
      text: t.shareAppLabel + " Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø´ÙÙ„ÙŠ",
      url: window.location.href
    };
    if (navigator.share) {
      navigator.share(shareData).catch(() => {});
    } else {
      alert(window.location.href);
    }
  }

  function initSettingsMenus() {
    const settingsButtons = document.querySelectorAll(".settings-btn");
    settingsButtons.forEach(btn => {
      const menuId = btn.getAttribute("data-menu");
      const menu = document.getElementById(menuId);
      if (!menu) return;

      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isVisible = menu.style.display === "block";
        document.querySelectorAll(".settings-menu")
          .forEach(m => m.style.display = "none");
        menu.style.display = isVisible ? "none" : "block";
      });
    });

    document.addEventListener("click", () => {
      document.querySelectorAll(".settings-menu")
        .forEach(m => m.style.display = "none");
    });

    const langButtons = document.querySelectorAll(".lang-btn");
    langButtons.forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const lang = btn.getAttribute("data-lang");
        setLanguage(lang);
      });
    });

    const shareButtons = document.querySelectorAll(".settings-share");
    shareButtons.forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleShareApp();
      });
    });

    const themeBtn = document.getElementById("theme-toggle-btn");
    if (themeBtn) {
      themeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleTheme();
      });
    }
  }

  function initWelcomeOverlay() {
    const overlay = document.getElementById("welcome-overlay");
    const okBtn = document.getElementById("welcome-ok-btn");
    if (!overlay || !okBtn) return;

    const alreadyShown = localStorage.getItem(WELCOME_KEY);
    if (!alreadyShown) {
      overlay.style.display = "flex";
    }

    okBtn.addEventListener("click", () => {
      localStorage.setItem(WELCOME_KEY, "1");
      overlay.style.display = "none";
    });
  }

  function initApp() {
    const namesTextarea = document.getElementById("names");
    if (namesTextarea) {
      namesTextarea.readOnly = true;
      // Ø±Ø¨Ø· Ø§Ù„Ù€ input event Ø¹Ø´Ø§Ù† ÙƒÙ„ ÙƒØªØ§Ø¨Ø© ØªØªØ²Ø§Ù…Ù† (ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
      namesTextarea.addEventListener("input", onNamesInput);
    }

    const hideBtn = document.getElementById("hideNamesBtn");
    const autoBtn = document.getElementById("autoModeBtn");
    const startBtn = document.getElementById("startDrawBtn");
    const resetBtn = document.getElementById("resetBtn");
    const editBtn = document.getElementById("editToggleBtn");
    const clearBtn = document.getElementById("clearNamesBtn");

    if (hideBtn) hideBtn.addEventListener("click", hideNames);
    if (autoBtn) autoBtn.addEventListener("click", enableAutoMode);
    if (startBtn) startBtn.addEventListener("click", startDraw);
    if (resetBtn) resetBtn.addEventListener("click", resetWinners);
    if (editBtn) editBtn.addEventListener("click", toggleEditMode);
    if (clearBtn) clearBtn.addEventListener("click", clearNames);

    setLanguage("ar");
    applyThemeFromStorage();
    initSettingsMenus();

    // Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø­Ù…Ù„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø«Ù… Ù†Ø³Ù…Ø¹ Ù…Ù† Firestore
    loadSavedLocalData();
    subscribeToRemoteNames();

    const appScreen = document.getElementById("app-screen");
    if (appScreen) appScreen.style.display = "flex";
  }

  function initPasswordGate() {
    const overlay = document.getElementById("password-overlay");
    const input = document.getElementById("password-input");
    const submit = document.getElementById("password-submit");
    const msg = document.getElementById("password-message");

    if (!overlay || !input || !submit || !msg) {
      // Ù„Ùˆ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© Ø¨Ø£ÙŠ Ø¹Ù†ØµØ±ØŒ Ù†ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø©
      initApp();
      initWelcomeOverlay();
      return;
    }

    overlay.style.display = "flex";

    const tryEnter = () => {
      const val = input.value.trim();
      if (val === ACCESS_CODE) {
        overlay.style.display = "none";
        initApp();
        initWelcomeOverlay();
      } else {
        msg.textContent = translations[currentLang].passwordError;
        msg.style.color = "var(--warning)";
        input.value = "";
        input.focus();
      }
    };

    submit.addEventListener("click", tryEnter);
    input.addEventListener("keyup", (e) => {
      if (e.key === "Enter") tryEnter();
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Ø£ÙˆÙ„ Ø´ÙŠØ¡: Ù„ØºØ© + Ø«ÙŠÙ… + Ø´Ø§Ø´Ø© Ø§Ù„ÙƒÙˆØ¯
    setLanguage("ar");
    applyThemeFromStorage();
    initPasswordGate();
  });
</script>

</body>
</html>
